name: ğŸš€ Automated Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version type to release (major, minor, patch)'
        required: false
        default: ''
        type: choice
        options:
        - ''
        - 'major'
        - 'minor' 
        - 'patch'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

jobs:
  release:
    name: ğŸ¯ Semantic Release
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-semantic-release==10.3.0
          pip install -r requirements.txt

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ” Validate Configuration
        run: |
          echo "ğŸ”§ Python Semantic Release Configuration"
          semantic-release --help
          
          echo "ğŸ“‹ Current Git Status"
          git status --porcelain
          
          echo "ğŸ“Š Latest Commits"
          git log --oneline -5

      - name: ğŸ§ª Test Configuration (Dry Run)
        run: |
          echo "ğŸ§ª Testing release configuration without making changes"
          semantic-release --noop version --print
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: ğŸ—ï¸ Build Package
        run: |
          echo "ğŸ—ï¸ Building Python package"
          python -m pip install build
          python -m build --sdist --wheel --outdir dist/
          
          echo "ğŸ“ Build artifacts:"
          ls -la dist/

      - name: âœ… Run Tests
        run: |
          echo "ğŸ§ª Running test suite before release"
          # Add your test commands here
          python -m pytest --version || echo "âš ï¸ pytest not available, skipping tests"
          # python -m pytest tests/ -v || echo "âš ï¸ Tests failed or not found"

      - name: ğŸš€ Semantic Release
        id: release
        if: github.event_name == 'push'
        run: |
          echo "ğŸš€ Running semantic-release for automatic versioning"
          semantic-release version
          semantic-release publish
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: ğŸ¯ Manual Release
        id: manual-release
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version != ''
        run: |
          echo "ğŸ¯ Running manual release with version: ${{ github.event.inputs.version }}"
          semantic-release version --${{ github.event.inputs.version }}
          semantic-release publish
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: ğŸ“ˆ Upload Release Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/
            CHANGELOG.md
          retention-days: 30

  docker-publish:
    name: ğŸ³ Publish Docker Images
    runs-on: ubuntu-latest
    environment: production
    needs: [release]
    if: success() && needs.release.outputs.tag != ''
    timeout-minutes: 60
    
    strategy:
      matrix:
        service: [api, scheduler, worker]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸ·ï¸ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/ordinaut-${{ matrix.service }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}},value=${{ needs.release.outputs.tag }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release.outputs.tag }}
            type=semver,pattern={{major}},value=${{ needs.release.outputs.tag }}
            type=sha,prefix={{branch}}-,suffix=-{{date 'YYYYMMDD-HHmmss'}},enable=true
          labels: |
            org.opencontainers.image.title=Ordinaut ${{ matrix.service }}
            org.opencontainers.image.description=AI agent orchestrator - ${{ matrix.service }} service
            org.opencontainers.image.vendor=Yoda Digital
            org.opencontainers.image.version=${{ needs.release.outputs.tag }}

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host

      - name: ğŸ—ï¸ Set up QEMU (Multi-arch)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GH_TOKEN }}

      - name: ğŸ—ï¸ Build and Push Multi-arch Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./ops/Dockerfile.${{ matrix.service }}
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          provenance: true
          sbom: true
          annotations: |
            org.opencontainers.image.title=Ordinaut ${{ matrix.service }}
            org.opencontainers.image.description=AI agent orchestrator - ${{ matrix.service }} service
            org.opencontainers.image.version=${{ needs.release.outputs.tag }}

      - name: ğŸ” Generate Security Attestation
        uses: actions/attest-build-provenance@v1
        id: attest
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/ordinaut-${{ matrix.service }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: ğŸ“Š Image Summary
        run: |
          echo "## ğŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`ghcr.io/${{ github.repository_owner }}/ordinaut-${{ matrix.service }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.release.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: \`linux/amd64, linux/arm64, linux/arm/v7\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Attestation**: âœ… Signed with build provenance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Usage" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm ghcr.io/${{ github.repository_owner }}/ordinaut-${{ matrix.service }}:${{ needs.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  post-release:
    name: ğŸ“Š Post-Release Tasks
    runs-on: ubuntu-latest
    environment: production
    needs: [release, docker-publish]
    if: always() && needs.release.result == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸ·ï¸ Get Latest Release
        id: latest-release
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "Latest tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ“ Update Release Notes
        if: steps.latest-release.outputs.tag != ''
        run: |
          echo "ğŸ“ Release ${{ steps.latest-release.outputs.tag }} completed successfully"
          echo "ğŸ‰ Ordinaut version ${{ steps.latest-release.outputs.tag }} has been released!"
          echo ""
          echo "## What's New"
          echo "This release was automatically generated using semantic versioning based on conventional commits."
          echo ""
          echo "## Installation"
          echo '```bash'
          echo 'pip install ordinaut==${{ steps.latest-release.outputs.tag }}'
          echo '```'
          echo ""
          echo "## Documentation"
          echo "- [API Documentation](https://github.com/yoda-digital/ordinaut/blob/${{ steps.latest-release.outputs.tag }}/README.md)"
          echo "- [Production Deployment](https://github.com/yoda-digital/ordinaut/blob/${{ steps.latest-release.outputs.tag }}/CLAUDE.md)"

      - name: ğŸ”” Notify Success
        if: success()
        run: |
          echo "âœ… Release pipeline completed successfully!"
          echo "ğŸš€ New version: ${{ steps.latest-release.outputs.tag }}"
          echo "ğŸ“¦ Artifacts uploaded to GitHub Releases"
          echo "ğŸ³ Docker images published to GHCR:"
          echo "  - ghcr.io/${{ github.repository_owner }}/ordinaut-api:${{ steps.latest-release.outputs.tag }}"
          echo "  - ghcr.io/${{ github.repository_owner }}/ordinaut-scheduler:${{ steps.latest-release.outputs.tag }}"
          echo "  - ghcr.io/${{ github.repository_owner }}/ordinaut-worker:${{ steps.latest-release.outputs.tag }}"
          echo "ğŸ—ï¸ Multi-architecture support: linux/amd64, linux/arm64, linux/arm/v7"
          echo "ğŸ”’ Security attestations: Build provenance and SBOM included"
          echo "ğŸ“Š Metrics and observability maintained"
          
          # Check Docker publishing status
          if [ "${{ needs.docker-publish.result }}" = "success" ]; then
            echo "âœ… Docker images published successfully"
          elif [ "${{ needs.docker-publish.result }}" = "failure" ]; then
            echo "âš ï¸ Docker image publishing failed - check logs"
          elif [ "${{ needs.docker-publish.result }}" = "skipped" ]; then
            echo "â„¹ï¸ Docker image publishing skipped"
          fi

  notify-failure:
    name: ğŸš¨ Notify Failure
    runs-on: ubuntu-latest
    needs: [release, docker-publish]
    if: always() && (needs.release.result == 'failure' || needs.docker-publish.result == 'failure')
    
    steps:
      - name: ğŸš¨ Pipeline Failed
        run: |
          echo "âŒ Release pipeline failed!"
          echo ""
          
          # Check specific failure points
          if [ "${{ needs.release.result }}" = "failure" ]; then
            echo "ğŸ’¥ Semantic release failed"
            echo "   - Version bumping or changelog generation failed"
            echo "   - Check commit message format (conventional commits required)"
          fi
          
          if [ "${{ needs.docker-publish.result }}" = "failure" ]; then
            echo "ğŸ³ Docker image publishing failed"
            echo "   - Multi-architecture build or GHCR push failed"
            echo "   - Check Docker build logs and registry permissions"
          fi
          
          echo ""
          echo "ğŸ” Check the workflow logs for details"
          echo "ğŸ“§ Consider manual intervention if needed"
          echo ""
          echo "ğŸ”§ Common fixes:"
          echo "   - Ensure commit follows conventional commit format"
          echo "   - Verify GHCR registry permissions"
          echo "   - Check Dockerfile syntax and build context"
          exit 1
