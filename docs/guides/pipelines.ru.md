# Конвейеры и инструменты

Сила Ordinaut заключается в его декларативном движке конвейеров, который выполняет последовательность шагов предсказуемым и надежным способом.

## Структура конвейера

Конвейер — это JSON-массив **шагов**, определенных в `payload` Задачи. Движок обрабатывает эти шаги по порядку, передавая контекст между ними.

```json
{
  "payload": {
    "params": { "city": "Chisinau" },
    "pipeline": [
      {
        "id": "get_weather",
        "uses": "weather-api.get_forecast",
        "with": {"location": "${params.city}"},
        "save_as": "weather"
      },
      {
        "id": "send_alert",
        "uses": "telegram.send_message",
        "if": "steps.weather.temperature > 25",
        "with": {
          "message": "Сегодня жарко: ${steps.weather.temperature}°C"
        }
      }
    ]
  }
}
```

### Ключевые свойства шага

- `id`: Уникальный идентификатор шага в конвейере.
- `uses`: Адрес **Инструмента** для выполнения (например, `weather-api.get_forecast`).
- `with`: Объект, содержащий аргументы для инструмента. Этот раздел поддерживает переменные-шаблоны.
- `save_as`: Ключ, под которым будет сохранен вывод шага в контексте. Это позволяет последующим шагам использовать результат (например, `steps.weather`).
- `if`: Условное выражение [JMESPath](https://jmespath.org/). Если оно вычисляется в «ложное» значение (например, `false`, `null`, `[]`, `{}`), шаг пропускается.
- `timeout_seconds`: Необязательный тайм-аут для вызова инструмента (по умолчанию 30 секунд).
- `max_retries`: Необязательное количество повторных попыток для этого конкретного шага в случае сбоя.

## Переменные-шаблоны

Вы можете динамически вставлять данные в блок `with`, используя переменные-шаблоны, которые разрешаются с помощью выражений JMESPath относительно текущего контекста.

- **`${params.variable_name}`**: Доступ к параметрам, определенным в разделе `payload.params` задачи.
- **`${steps.step_id.output_field}`**: Доступ к выводу предыдущего шага, который использовал `save_as`. Вы можете обходить вложенные объекты JSON (например, `${steps.weather.details.humidity}`).
- **`${now}`**: Специальная переменная, которая предоставляет текущую временную метку UTC в формате ISO 8601.

## Каталог инструментов

Инструменты — это строительные блоки конвейеров. Они представляют собой определенную возможность, например, отправку электронной почты или запрос к базе данных. Каждый инструмент определен в центральном каталоге и имеет строгий контракт:

- **Адрес:** Уникальный, удобочитаемый идентификатор (например, `google-calendar.list_events`).
- **Схема ввода:** Схема JSON, которая определяет ожидаемые аргументы. Движок конвейера проверяет блок `with` шага по этой схеме перед выполнением.
- **Схема вывода:** Схема JSON, которая определяет ожидаемый результат. Движок проверяет ответ инструмента по этой схеме после выполнения.

Этот подход, основанный на схемах, гарантирует, что все взаимодействия предсказуемы, проверены и типобезопасны, что критически важно для создания надежных автоматизаций.

## Обработка ошибок

Если шаг завершается неудачно (например, вызов инструмента превышает тайм-аут или возвращает ошибку), движок будет соблюдать политику `max_retries`, определенную в задаче или на самом шаге. Если все повторные попытки завершаются неудачно, весь запуск конвейера помечается как `неудачный`, и детали ошибки записываются в объект **Запуска**.
