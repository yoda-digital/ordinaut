# Планирование с помощью RRULE

Ordinaut использует мощный стандарт **RFC 5545 Recurrence Rule (RRULE)** для всех сложных, учитывающих календарь, расписаний. Это позволяет определять сложные графики, которые выходят далеко за рамки возможностей традиционных выражений cron.

При создании задачи установите `schedule_kind` в `rrule` и укажите строку правила в `schedule_expr`.

## Распространенные примеры RRULE

Вот несколько практических примеров, которые вы можете использовать в своих задачах.

| Сценарий использования                               | Выражение RRULE                                        |
|:-----------------------------------------------------|:-------------------------------------------------------|
| Каждый будний день в 8:30                             | `FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR;BYHOUR=8;BYMINUTE=30`  |
| Каждый второй понедельник в 10:00                     | `FREQ=WEEKLY;INTERVAL=2;BYDAY=MO;BYHOUR=10`              |
| В последнюю пятницу каждого месяца в 17:00            | `FREQ=MONTHLY;BYDAY=FR;BYSETPOS=-1;BYHOUR=17`            |
| В первый день каждого квартала в 9:00                  | `FREQ=MONTHLY;INTERVAL=3;BYMONTHDAY=1;BYHOUR=9`          |
| Ежегодно 15 июня                                     | `FREQ=YEARLY;BYMONTH=6;BYMONTHDAY=15`                    |
| Дважды в день (в 9:00 и 18:00)                         | `FREQ=DAILY;BYHOUR=9,18`                                 |

## Ключевые компоненты RRULE

Строка RRULE — это список свойств, разделенных точкой с запятой.

- **`FREQ`**: Базовая частота повторения (например, `DAILY`, `WEEKLY`, `MONTHLY`, `YEARLY`).
- **`INTERVAL`**: Работает с `FREQ` для указания интервалов. `FREQ=WEEKLY;INTERVAL=2` означает каждые две недели.
- **`BYDAY`**: Указывает дни недели (`MO`, `TU`, `WE`, `TH`, `FR`, `SA`, `SU`).
- **`BYMONTHDAY`**: Указывает день месяца (например, `1`, `15`, `-1` для последнего дня).
- **`BYMONTH`**: Указывает месяц года (1-12).
- **`BYHOUR`**, **`BYMINUTE`**, **`BYSECOND`**: Указывает время суток.
- **`BYSETPOS`**: Используется с другими правилами `BY` для выбора определенного вхождения из сгенерированного набора. `BYSETPOS=-1` — это способ выбрать *последнее* вхождение в периоде.

## Часовые пояса и летнее время (DST)

Обработка RRULE в Ordinaut полностью учитывает часовые пояса. **Критически важно** указать действительное имя `timezone` (например, `Europe/Chisinau`) в определении вашей задачи. Система использует этот часовой пояс для:

- Правильной интерпретации времени начала правила.
- Автоматической обработки переходов на летнее время (DST), гарантируя, что ваши задачи будут выполняться в правильное местное время круглый год.
- Точного расчета всех будущих вхождений.

### Пример задачи с RRULE

```json
{
  "title": "Ежемесячный финансовый отчет",
  "description": "Создание финансового отчета в последний рабочий день месяца.",
  "schedule_kind": "rrule",
  "schedule_expr": "FREQ=MONTHLY;BYDAY=MO,TU,WE,TH,FR;BYSETPOS=-1;BYHOUR=17;BYMINUTE=0",
  "timezone": "Europe/Chisinau",
  "payload": { ... },
  "created_by": "..."
}
```

Эта задача будет надежно выполняться в 17:00 в последний рабочий день каждого месяца, независимо от того, будет ли это 28, 29, 30 или 31 число, и она будет правильно корректироваться с учетом летнего времени.