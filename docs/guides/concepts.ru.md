# Основные концепции

Понимание этих основных концепций является ключом к эффективному использованию Ordinaut. Они составляют строительные блоки любой создаваемой вами автоматизации.

---

### Агент

**Агент** — это действующее лицо в системе, представляющее AI-помощника, подключенного через MCP. Каждый агент идентифицируется уникальным ID (UUID) и токеном аутентификации. Агенты владеют задачами и инициируют действия от имени пользователей через чат-интерфейсы. Вы можете создавать разных агентов для разных AI-помощников (например, `claude-assistant`, `gpt-assistant`) и предоставлять им определенные разрешения (области действия) для контроля над тем, что им разрешено делать.

---

### Задача (Task)

**Задача** — это фундаментальная единица работы в Ordinaut. Это постоянный объект, который объединяет *что*, *когда* и *как* выполняется автоматизация.

Объект задачи содержит:
- **Метаданные:** `title` (заголовок) и `description` (описание) для удобства чтения человеком.
- **Расписание (Schedule):** Определяет, *когда* должна выполняться задача.
- **Конвейер (Pipeline):** Определяет последовательность шагов для выполнения.
- **Политика выполнения:** Определяет, *как* должна выполняться задача, включая ее `priority` (приоритет), `max_retries` (максимальное количество повторных попыток) и `concurrency_key` (ключ параллелизма).
- **Владение:** Поле `created_by` связывает задачу с Агентом.

---

### Расписание (Schedule)

**Расписание** определяет, когда запускается задача. Ordinaut предоставляет очень гибкую систему планирования, которая поддерживает несколько типов триггеров.

| `schedule_kind` | Описание                                                                                             | Пример `schedule_expr`                                     |
|:----------------|:--------------------------------------------------------------------------------------------------------|:------------------------------------------------------------|
| `cron`          | Использует стандартный 5-польный синтаксис cron для повторяющихся расписаний.                           | `"0 9 * * 1-5"` (Каждый будний день в 9:00)                |
| `rrule`         | Использует правила повторения RFC-5545 для сложной календарной логики.                                   | `"FREQ=MONTHLY;BYDAY=-1FR"` (В последнюю пятницу каждого месяца) |
| `once`          | Выполняет задачу один раз в определенное время по метке времени ISO 8601.                               | `"2025-12-31T23:59:59Z"`                                  |
| `event`         | Запускает задачу при публикации соответствующего события в системе.                                      | `"user.email.received"`                                   |

!!! tip "Часовые пояса важны"
    Все расписания учитывают часовые пояса. Вы всегда должны указывать `timezone` (например, `Europe/Chisinau`) в определении задачи, чтобы гарантировать, что расписания срабатывают в правильное местное время, особенно при переходе на летнее/зимнее время.

---

### Конвейер (Pipeline)

**Конвейер** — это сердце задачи, декларативное определение работы, которую необходимо выполнить. Он состоит из упорядоченного списка **Шагов**.

- **Поток данных:** Вывод одного шага может использоваться как ввод для последующих шагов, что позволяет связывать операции в цепочку.
- **Параметры:** Конвейеры могут получать начальные данные из объекта `payload.params` в определении задачи.
- **Условная логика:** Шаги могут выполняться условно на основе вывода предыдущих шагов.

---

### Шаг (Step)

**Шаг** — это единичное, атомарное действие в конвейере. Каждый шаг имеет несколько ключевых свойств:

- `id`: Уникальный идентификатор шага в конвейере.
- `uses`: Адрес **Инструмента (Tool)**, который необходимо выполнить (например, `telegram.send_message`).
- `with`: Объект, содержащий аргументы для передачи инструменту. Этот раздел поддерживает переменные-шаблоны.
- `save_as`: Имя, под которым будет сохранен вывод шага. Это делает результат доступным для последующих шагов через контекст `steps`.
- `if`: Условное выражение, которое определяет, должен ли выполняться шаг.

---

### Инструмент (Tool)

**Инструмент** — это зарегистрированная, многоразовая возможность, которую можно вызвать из шага конвейера. Каждый инструмент имеет строго определенную **схему ввода (input schema)** и **схему вывода (output schema)**, что обеспечивает предсказуемость и валидность данных, проходящих через конвейер. Ordinaut можно расширять инструментами, которые подключаются к любому внешнему API или сервису.

---

### Запуск (Run)

**Запуск** — это запись одного выполнения конвейера задачи. Каждый раз, когда задача запускается по расписанию или событию, создается новый объект Запуска. Этот объект отслеживает:

- Время начала и окончания выполнения.
- Окончательный статус (`успех` или `неудача`).
- Количество `попыток` повторного выполнения.
- Подробный `вывод` конвейера, включая результаты каждого шага.
- Любую возникшую `ошибку`.

Это обеспечивает полный, проверяемый аудитом истории каждого действия, предпринимаемого системой.

---

### Очередь `due_work`

Это внутренняя таблица базы данных, которая действует как очередь заданий. Единственная задача **Планировщика** — вычислить следующее время выполнения для каждой задачи и вставить соответствующую строку в таблицу `due_work`. **Воркеры** затем опрашивают эту таблицу, безопасно арендуют задания с помощью `FOR UPDATE SKIP LOCKED` и выполняют их. Такое разделение планирования и выполнения является основой надежности и масштабируемости Ordinaut.
